import { Navbar } from "@/components/Navbar";
import { useState, useRef, useEffect } from "react";
import { Link } from "react-router-dom";
import { PieChart, Pie, Cell, ResponsiveContainer, Tooltip } from "recharts";
import { ChevronLeft, ChevronRight, FileText, Video, ExternalLink, CheckCircle, ArrowRight, Info } from "lucide-react";

const NGOProfile = () => {
  const [currentSlide, setCurrentSlide] = useState(0);
  const [donationAmount, setDonationAmount] = useState("1000");
  const [selectedPaymentMethod, setSelectedPaymentMethod] = useState("upi");
  const [isVideoPlaying, setIsVideoPlaying] = useState({
    shruti: false,
    khushi: false
  });
  const [videoProgress, setVideoProgress] = useState({
    khushi: 0,
    shruti: 0
  });
  const [donationProgress, setDonationProgress] = useState(0);
  const totalDonationNeeded = 124000; // Total amount needed

  const videoRefs = {
    shruti: useRef<HTMLVideoElement>(null),
    khushi: useRef<HTMLVideoElement>(null)
  };

  const impactImages = [
    {
      img: "photo1.jpg.jpg",
      alt: "Impact Photo 1",
      caption: "First impact photo caption"
    },
    {
      type: "video",
      videoUrl: "impact-video.mp4",
      poster: "photo2.jpg",
      alt: "Impact Video",
      caption: "Watch our impact story"
    },
    {
      img: "photo2.jpg",
      alt: "Impact Photo 2",
      caption: "Second impact photo caption"
    },
    {
      img: "photo3.jpg",
      alt: "Impact Photo 3",
      caption: "Third impact photo caption"
    }
  ];

  const donationBreakdown = [
    { name: "Tuition Fees - Shruti", value: 40000 },
    { name: "Tuition Fees - Khushi", value: 72000 },
    { name: "Administration Cost", value: 12000 }
  ];

  const totalDonation = donationBreakdown.reduce((sum, item) => sum + item.value, 0);

  const COLORS = ["#4299E1", "#38B2AC", "#ED8936"];
  
  const nextSlide = () => {
    setCurrentSlide((prev) => (prev + 1) % impactImages.length);
  };

  const prevSlide = () => {
    setCurrentSlide((prev) => (prev - 1 + impactImages.length) % impactImages.length);
  };

  const toggleVideo = (student: 'shruti' | 'khushi') => {
    const videoElement = videoRefs[student].current;
    
    if (videoElement) {
      if (isVideoPlaying[student]) {
        videoElement.pause();
      } else {
        // Pause other video if playing
        const otherStudent = student === 'shruti' ? 'khushi' : 'shruti';
        const otherVideo = videoRefs[otherStudent].current;
        if (otherVideo && !otherVideo.paused) {
          otherVideo.pause();
          setIsVideoPlaying(prev => ({ ...prev, [otherStudent]: false }));
        }
        
        videoElement.play();
      }
      
      setIsVideoPlaying(prev => ({
        ...prev,
        [student]: !prev[student]
      }));
    }
  };

  const handleTimeUpdate = (student: 'khushi' | 'shruti') => {
    const video = videoRefs[student].current;
    if (video) {
      const progress = (video.currentTime / video.duration) * 100;
      setVideoProgress(prev => ({ ...prev, [student]: progress }));
    }
  };

  // Calculate donation progress
  useEffect(() => {
    const progress = (parseInt(donationAmount) / totalDonationNeeded) * 100;
    setDonationProgress(Math.min(progress, 100));
  }, [donationAmount]);

  return (
    <div className="min-h-screen bg-white">
      <Navbar />
      <main className="pt-24 pb-16">
        {/* Visual Impact Carousel */}
        <section className="relative h-[600px] mb-10 overflow-hidden">
          {impactImages.map((item, index) => (
            <div
              key={index}
              className={`absolute inset-0 transition-opacity duration-1000 ${
                index === currentSlide ? "opacity-100" : "opacity-0"
              }`}
            >
              {item.type === "video" ? (
                <div className="w-full h-full flex items-center justify-center bg-black">
                  <video
                    src={item.videoUrl}
                    poster={item.poster}
                    className="w-full h-full object-contain"
                    controls
                    playsInline
                    onError={(e) => {
                      console.error("Video loading error:", e);
                      console.error("Video URL:", item.videoUrl);
                      console.error("Full path:", window.location.origin + item.videoUrl);
                    }}
                  />
                </div>
              ) : (
                <div className="w-full h-full flex items-center justify-center bg-black">
                  <img
                    src={item.img}
                    alt={item.alt}
                    className="w-full h-full object-contain"
                    onError={(e) => {
                      console.error("Image loading error:", e);
                      console.error("Image path:", item.img);
                      console.error("Full path:", window.location.origin + item.img);
                    }}
                  />
                </div>
              )}
              <div className="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent" />
              <div className="absolute bottom-0 left-0 w-full p-8 text-white">
                <h2 className="text-4xl font-bold mb-2">Trishul NGO</h2>
                <p className="text-xl max-w-2xl">{item.caption}</p>
              </div>
            </div>
          ))}
          
          {/* Carousel Controls */}
          <button 
            onClick={prevSlide}
            className="absolute left-4 top-1/2 transform -translate-y-1/2 bg-white/20 hover:bg-white/40 text-white p-3 rounded-full z-10"
          >
            <ChevronLeft className="w-6 h-6" />
          </button>
          <button 
            onClick={nextSlide}
            className="absolute right-4 top-1/2 transform -translate-y-1/2 bg-white/20 hover:bg-white/40 text-white p-3 rounded-full z-10"
          >
            <ChevronRight className="w-6 h-6" />
          </button>
          
          {/* Indicator Dots */}
          <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex space-x-2">
            {impactImages.map((_, index) => (
              <button
                key={index}
                onClick={() => setCurrentSlide(index)}
                className={`w-3 h-3 rounded-full transition-colors ${
                  currentSlide === index ? "bg-white" : "bg-white/40"
                }`}
                aria-label={`Go to slide ${index + 1}`}
              />
            ))}
          </div>
        </section>

        <div className="container mx-auto px-4">
          <div className="flex flex-col lg:flex-row gap-8">
            {/* Left Column - Main Content */}
            <div className="lg:w-2/3">
              {/* About Section */}
              <section className="bg-white rounded-xl shadow-sm p-8 mb-8">
                <h2 className="text-3xl font-bold mb-4">About Trishul NGO</h2>
                <p className="text-gray-700 leading-relaxed mb-6">
                  A registered charitable trust building self-sustainable communities in India's urban slums and rural villages. 
                  For over 20 years, Trishul has empowered over 50,000 families through programs in skill development, 
                  education, women's livelihood, hygiene, nutrition, youth empowerment, and environmental conservation.
                </p>
                <div className="flex flex-wrap gap-2">
                  <span className="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">Education</span>
                  <span className="px-3 py-1 bg-teal-100 text-teal-800 rounded-full text-sm">Women Empowerment</span>
                  <span className="px-3 py-1 bg-orange-100 text-orange-800 rounded-full text-sm">Skill Development</span>
                  <span className="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">Environmental Conservation</span>
                </div>
              </section>
              
              {/* Current Offering */}
              <section className="bg-white rounded-xl shadow-sm p-8 mb-8">
                <div className="flex items-center justify-between mb-4">
                  <h2 className="text-3xl font-bold">Current Offering</h2>
                  <Link 
                    to="#donate" 
                    className="bg-orange-500 hover:bg-orange-600 text-white px-5 py-2 rounded-full flex items-center transition-colors"
                    onClick={(e) => {
                      e.preventDefault();
                      document.getElementById('donation-section')?.scrollIntoView({ behavior: 'smooth' });
                    }}
                  >
                    Sponsor This Now
                    <ArrowRight className="ml-2 w-4 h-4" />
                  </Link>
                </div>
                
                <div className="p-6 bg-gradient-to-r from-blue-50 to-teal-50 rounded-lg mb-6">
                  <h3 className="text-xl font-semibold mb-4 text-gray-800">
                    Sponsor 2 Girl Children
                  </h3>
                  <p className="text-gray-700 mb-6">
                    Your contribution will sponsor the education and basic needs of two underprivileged 
                    girls for a full academic year, including tuition, books, uniforms, and nutrition.
                  </p>
                  
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="bg-white p-6 rounded-lg shadow-sm">
                      <div className="flex items-start">
                        <div className="p-2 bg-blue-100 rounded-full mr-4">
                          <span className="text-blue-600 text-xl font-bold">K</span>
                        </div>
                        <div>
                          <h4 className="font-semibold text-lg">Khushi</h4>
                          <p className="text-sm text-gray-600">12 years • Class 7</p>
                          <p className="mt-2 text-gray-700">
                            Dreams of becoming a doctor. Khushi is an exceptional student 
                            with a passion for science.
                          </p>
                        </div>
                      </div>
                    </div>
                    
                    <div className="bg-white p-6 rounded-lg shadow-sm">
                      <div className="flex items-start">
                        <div className="p-2 bg-teal-100 rounded-full mr-4">
                          <span className="text-teal-600 text-xl font-bold">S</span>
                        </div>
                        <div>
                          <h4 className="font-semibold text-lg">Shruti</h4>
                          <p className="text-sm text-gray-600">10 years • Class 5</p>
                          <p className="mt-2 text-gray-700">
                            Aspires to be an artist. Shruti shows remarkable talent in 
                            drawing and creative pursuits.
                          </p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </section>
              
              {/* Donation Breakdown */}
              <section className="bg-white rounded-xl shadow-sm p-8 mb-8">
                <h2 className="text-3xl font-bold mb-6">Donation Breakdown</h2>
                
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center">
                  <div className="h-[300px]">
                    <ResponsiveContainer width="100%" height="100%">
                      <PieChart>
                        <Pie
                          data={donationBreakdown}
                          cx="50%"
                          cy="50%"
                          innerRadius={60}
                          outerRadius={90}
                          fill="#8884d8"
                          paddingAngle={4}
                          dataKey="value"
                          label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}
                          labelLine={false}
                        >
                          {donationBreakdown.map((entry, index) => (
                            <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                          ))}
                        </Pie>
                        <Tooltip 
                          formatter={(value) => `₹${value.toLocaleString()}`}
                        />
                      </PieChart>
                    </ResponsiveContainer>
                  </div>
                  
                  <div className="overflow-x-auto">
                    <table className="min-w-full divide-y divide-gray-200">
                      <thead className="bg-gray-50">
                        <tr>
                          <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Expense Category
                          </th>
                          <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                            Amount (₹)
                          </th>
                        </tr>
                      </thead>
                      <tbody className="bg-white divide-y divide-gray-200">
                        {donationBreakdown.map((item, index) => (
                          <tr key={index}>
                            <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                              <div className="flex items-center">
                                <span 
                                  className="w-3 h-3 rounded-full mr-2" 
                                  style={{ backgroundColor: COLORS[index % COLORS.length] }}
                                ></span>
                                {item.name}
                              </div>
                            </td>
                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">
                              {item.value.toLocaleString()}
                            </td>
                          </tr>
                        ))}
                        <tr className="bg-gray-50">
                          <td className="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900">
                            Total Sponsorship Cost
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900 text-right">
                            ₹{totalDonation.toLocaleString()}
                          </td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </section>
              
              {/* Proof & Documentation */}
              <section className="bg-white rounded-xl shadow-sm p-8 mb-8">
                <h2 className="text-3xl font-bold mb-6">Proof & Documentation</h2>
                
                <div className="grid grid-cols-1 gap-4">
                  <a
                    href="/tuition-fees-proof.pdf"
                    target="_blank"
                    rel="noopener noreferrer"
                    className="flex items-center p-5 border border-gray-100 rounded-lg hover:bg-gray-50 transition-colors"
                  >
                    <div className="mr-4 bg-blue-100 p-3 rounded-lg">
                      <FileText className="w-6 h-6 text-blue-600" />
                    </div>
                    <div>
                      <h3 className="font-semibold text-gray-900">Tuition Fees Proof</h3>
                      <p className="text-sm text-gray-600">Verified school fee receipts for Khushi and Shruti</p>
                    </div>
                  </a>
                </div>
                
                <div className="mt-6 flex items-center justify-center p-4 bg-blue-50 rounded-lg">
                  <CheckCircle className="w-5 h-5 text-blue-600 mr-2" />
                  <span className="text-blue-800">All documents verified by nyce club</span>
                </div>
              </section>
              
              {/* Stories of Sponsored Girls */}
              <section className="bg-white rounded-xl shadow-sm p-8 mb-8">
                <h2 className="text-3xl font-bold mb-6">Stories of Impact</h2>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                  <div className="rounded-lg overflow-hidden">
                    <div className="relative aspect-[9/16] bg-black">
                      <video
                        ref={videoRefs.khushi}
                        src="/khushi-story.mp4"
                        poster="/trishul-education.jpg"
                        className="w-full h-full object-contain"
                        onPlay={() => setIsVideoPlaying(prev => ({ ...prev, khushi: true }))}
                        onPause={() => setIsVideoPlaying(prev => ({ ...prev, khushi: false }))}
                        onTimeUpdate={() => handleTimeUpdate('khushi')}
                      />
                      <div className="absolute inset-0 flex items-center justify-center">
                        {!isVideoPlaying.khushi ? (
                          <button
                            onClick={() => toggleVideo('khushi')}
                            className="w-20 h-20 rounded-full bg-black/50 hover:bg-black/70 flex items-center justify-center group z-10"
                          >
                            <div className="w-0 h-0 border-t-8 border-b-8 border-t-transparent border-b-transparent border-l-16 border-l-white ml-1"></div>
                          </button>
                        ) : (
                          <button
                            onClick={() => toggleVideo('khushi')}
                            className="w-20 h-20 rounded-full bg-black/50 hover:bg-black/70 flex items-center justify-center z-10"
                          >
                            <div className="flex space-x-2">
                              <div className="w-4 h-12 bg-white rounded-sm"></div>
                              <div className="w-4 h-12 bg-white rounded-sm"></div>
                            </div>
                          </button>
                        )}
                      </div>
                      <div className="absolute bottom-0 left-0 w-full p-4 bg-gradient-to-t from-black/80 to-transparent">
                        <div className="w-full bg-gray-300 h-1 rounded-full overflow-hidden">
                          <div 
                            className="bg-blue-500 h-full rounded-full" 
                            style={{ width: `${videoProgress.khushi}%` }}
                          ></div>
                        </div>
                        <span className="text-white font-medium text-lg mt-2 block">Khushi's Story</span>
                      </div>
                    </div>
                    <div className="p-4 bg-gray-50">
                      <h3 className="font-semibold text-lg">Khushi: Future Doctor</h3>
                      <p className="text-gray-700 mt-2">
                        "Thanks to the sponsorship, I can focus on my studies instead of worrying about 
                        school fees. I want to become a doctor and help my community."
                      </p>
                    </div>
                  </div>
                  
                  <div className="rounded-lg overflow-hidden">
                    <div className="relative aspect-[9/16] bg-black">
                      <video
                        ref={videoRefs.shruti}
                        src="/shruti-story.mp4"
                        poster="/trishul-women-empowerment.jpg"
                        className="w-full h-full object-contain"
                        onPlay={() => setIsVideoPlaying(prev => ({ ...prev, shruti: true }))}
                        onPause={() => setIsVideoPlaying(prev => ({ ...prev, shruti: false }))}
                        onTimeUpdate={() => handleTimeUpdate('shruti')}
                      />
                      <div className="absolute inset-0 flex items-center justify-center">
                        {!isVideoPlaying.shruti ? (
                          <button
                            onClick={() => toggleVideo('shruti')}
                            className="w-20 h-20 rounded-full bg-black/50 hover:bg-black/70 flex items-center justify-center group z-10"
                          >
                            <div className="w-0 h-0 border-t-8 border-b-8 border-t-transparent border-b-transparent border-l-16 border-l-white ml-1"></div>
                          </button>
                        ) : (
                          <button
                            onClick={() => toggleVideo('shruti')}
                            className="w-20 h-20 rounded-full bg-black/50 hover:bg-black/70 flex items-center justify-center z-10"
                          >
                            <div className="flex space-x-2">
                              <div className="w-4 h-12 bg-white rounded-sm"></div>
                              <div className="w-4 h-12 bg-white rounded-sm"></div>
                            </div>
                          </button>
                        )}
                      </div>
                      <div className="absolute bottom-0 left-0 w-full p-4 bg-gradient-to-t from-black/80 to-transparent">
                        <div className="w-full bg-gray-300 h-1 rounded-full overflow-hidden">
                          <div 
                            className="bg-teal-500 h-full rounded-full" 
                            style={{ width: `${videoProgress.shruti}%` }}
                          ></div>
                        </div>
                        <span className="text-white font-medium text-lg mt-2 block">Shruti's Story</span>
                      </div>
                    </div>
                    <div className="p-4 bg-gray-50">
                      <h3 className="font-semibold text-lg">Shruti: Aspiring Artist</h3>
                      <p className="text-gray-700 mt-2">
                        "I love my art classes the most. Before the sponsorship, we couldn't afford art supplies. 
                        Now I can practice every day and my teacher says I have talent."
                      </p>
                    </div>
                  </div>
                </div>
              </section>
            </div>
            
            {/* Right Column - Fixed Donation Module */}
            <div className="lg:w-1/3">
              <div id="donation-section" className="sticky top-32 bg-white rounded-xl shadow-lg p-6">
                <div className="border-b pb-4 mb-6">
                  <h2 className="text-2xl font-bold text-gray-900">Sponsor Two Girl Children</h2>
                  <p className="text-gray-600 text-sm mt-1">Your donation will support education for a full year</p>
                </div>
                
                <div className="mb-6">
                  <div className="flex justify-between text-sm text-gray-600 mb-2">
                    <span>Choose Amount</span>
                    <span className="flex items-center">
                      <Info className="w-4 h-4 mr-1" />
                      Total cost: ₹{totalDonation.toLocaleString()}
                    </span>
                  </div>
                  
                  {/* Preset Amounts */}
                  <div className="grid grid-cols-3 gap-2 mb-4">
                    {["500", "1000", "2500"].map((amount) => (
                      <button
                        key={amount}
                        className={`p-3 rounded-lg text-sm ${
                          donationAmount === amount
                            ? "bg-blue-600 text-white"
                            : "bg-gray-100 text-gray-800 hover:bg-gray-200"
                        }`}
                        onClick={() => setDonationAmount(amount)}
                      >
                        ₹{parseInt(amount).toLocaleString()}
                      </button>
                    ))}
                  </div>
                  
                  {/* Custom Amount */}
                  <div className="relative mb-6">
                    <div className="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none">
                      <span className="text-gray-500">₹</span>
                    </div>
                    <input
                      type="number"
                      placeholder="Custom amount"
                      className="w-full p-3 pl-8 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                      value={donationAmount}
                      onChange={(e) => setDonationAmount(e.target.value)}
                    />
                  </div>
                  
                  {/* Donation Progress Bar */}
                  <div className="mb-6">
                    <div className="flex justify-between text-sm text-gray-600 mb-2">
                      <span>Donation Progress</span>
                      <span>{Math.round(donationProgress)}%</span>
                    </div>
                    <div className="w-full bg-gray-200 rounded-full h-2.5">
                      <div 
                        className="bg-blue-600 h-2.5 rounded-full transition-all duration-300" 
                        style={{ width: `${donationProgress}%` }}
                      ></div>
                    </div>
                    <div className="flex justify-between text-xs text-gray-500 mt-1">
                      <span>₹0</span>
                      <span>₹{totalDonationNeeded.toLocaleString()}</span>
                    </div>
                  </div>
                  
                  {/* Payment Methods */}
                  <div className="mb-6">
                    <label className="block text-sm text-gray-600 mb-2">Payment Method</label>
                    <div className="grid grid-cols-3 gap-2">
                      <label
                        className={`flex items-center justify-center p-3 border rounded-lg cursor-pointer ${
                          selectedPaymentMethod === "upi"
                            ? "border-blue-500 bg-blue-50"
                            : "border-gray-200 hover:bg-gray-50"
                        }`}
                      >
                        <input
                          type="radio"
                          name="payment"
                          value="upi"
                          checked={selectedPaymentMethod === "upi"}
                          onChange={(e) => setSelectedPaymentMethod(e.target.value)}
                          className="sr-only"
                        />
                        <span className="text-sm">UPI</span>
                      </label>
                      
                      <label
                        className={`flex items-center justify-center p-3 border rounded-lg cursor-pointer ${
                          selectedPaymentMethod === "card"
                            ? "border-blue-500 bg-blue-50"
                            : "border-gray-200 hover:bg-gray-50"
                        }`}
                      >
                        <input
                          type="radio"
                          name="payment"
                          value="card"
                          checked={selectedPaymentMethod === "card"}
                          onChange={(e) => setSelectedPaymentMethod(e.target.value)}
                          className="sr-only"
                        />
                        <span className="text-sm">Card</span>
                      </label>
                      
                      <label
                        className={`flex items-center justify-center p-3 border rounded-lg cursor-pointer ${
                          selectedPaymentMethod === "netbanking"
                            ? "border-blue-500 bg-blue-50"
                            : "border-gray-200 hover:bg-gray-50"
                        }`}
                      >
                        <input
                          type="radio"
                          name="payment"
                          value="netbanking"
                          checked={selectedPaymentMethod === "netbanking"}
                          onChange={(e) => setSelectedPaymentMethod(e.target.value)}
                          className="sr-only"
                        />
                        <span className="text-sm">Netbanking</span>
                      </label>
                    </div>
                  </div>
                  
                  {/* UPI Link if UPI selected */}
                  {selectedPaymentMethod === "upi" && (
                    <div className="p-4 bg-gray-50 rounded-lg mb-6">
                      <p className="text-sm text-gray-600 mb-2">Scan QR code or click below:</p>
                      <a 
                        href="https://www.upi.me/pay?pa=stockswithharrit@okaxis" 
                        target="_blank" 
                        rel="noopener noreferrer"
                        className="inline-flex items-center text-blue-600 hover:text-blue-800 transition-colors"
                      >
                        <ExternalLink className="w-4 h-4 mr-1" />
                        <span>Pay via UPI</span>
                      </a>
                    </div>
                  )}
                  
                  {/* Sponsor Now Button */}
                  <button className="w-full bg-blue-600 hover:bg-blue-700 text-white py-4 px-6 rounded-lg font-bold transition-colors">
                    Sponsor Now
                  </button>
                  
                  {/* Trust Badges */}
                  <div className="mt-6 pt-6 border-t border-gray-100 flex flex-col items-center">
                    <div className="flex items-center justify-center space-x-3 mb-3">
                      <CheckCircle className="w-4 h-4 text-green-600" />
                      <span className="text-xs text-gray-600">Secure Payment</span>
                      
                      <CheckCircle className="w-4 h-4 text-green-600" />
                      <span className="text-xs text-gray-600">Tax Benefits</span>
                    </div>
                    <p className="text-xs text-center text-gray-500">
                      All donations are eligible for tax deduction under Section 80G
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  );
};

export default NGOProfile;